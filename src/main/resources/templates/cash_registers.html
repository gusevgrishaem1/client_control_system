<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление кассовыми аппаратами</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1200px;
            overflow-x: auto; /* Горизонтальная прокрутка */
        }
        h2 {
            text-align: center;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th {
            cursor: pointer;
            resize: horizontal;
            background-color: #f4f4f4;
        }
        th.sort-asc::after {
            content: " ▲";
        }
        th.sort-desc::after {
            content: " ▼";
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .pagination {
            margin-top: 10px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .pagination button:hover {
            background-color: #45a049;
        }
        .pagination button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .save-button, .cancel-button {
            display: none;
            margin-top: 10px;
            padding: 10px 20px;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .save-button {
            background-color: #4CAF50;
        }
        .save-button:hover {
            background-color: #45a049;
        }
        .cancel-button {
            background-color: #f44336;
        }
        .cancel-button:hover {
            background-color: #e53935;
        }
        .filter-container {
            margin-bottom: 10px;
        }
        .filter-container input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .filter-container th, .filter-container td {
            padding: 0;
            border: none;
        }
        #addCashRegisterForm {
            margin-bottom: 20px;
        }
        #addCashRegisterForm input {
            margin-bottom: 10px;
        }
        .delete-button {
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            padding: 5px 10px;
        }
        .delete-button:hover {
            background-color: #e53935;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Управление кассовыми аппаратами</h2>

    <div id="addCashRegisterForm">
        <h3>Добавить новый кассовый аппарат</h3>
        <input type="text" id="newFactoryNumber" placeholder="Номер завода" required/>
        <input type="text" id="newInstallationAddress" placeholder="Адрес установки" required/>
        <input type="text" id="newRegistrationNumber" placeholder="Регистрационный номер" required/>
        <input type="date" id="newActivationDate" placeholder="Дата активации" required/>
        <input type="date" id="newDeactivationDate" placeholder="Дата деактивации" required/>
        <input type="text" id="newFiscalType" placeholder="Тип фискальника" required/>
        <input type="text" id="newFiscalFactoryNumber" placeholder="Номер завода фискальника" required/>
        <input type="number" id="newFiscalValidity" placeholder="Срок годности фискальника" required/>
        <input type="date" id="newFiscalActivationDate" placeholder="Дата активации фискальника" required/>
        <input type="date" id="newFiscalDeactivationDate" placeholder="Дата деактивации фискальника" required/>
        <input type="text" id="newVersion" placeholder="Версия ПО" required/>
        <input type="date" id="newInstallationDate" placeholder="Дата установки ПО" required/>
        <button onclick="addCashRegister()">Добавить кассовый аппарат</button>
    </div>

    <table id="cashRegisterTable">
        <thead>
        <tr>
            <th style="width: 5%;" onclick="sortCurrentPage(0)">ID</th>
            <th style="width: 15%;" onclick="sortCurrentPage(1)">Номер завода</th>
            <th style="width: 20%;" onclick="sortCurrentPage(2)">Адрес установки</th>
            <th style="width: 15%;" onclick="sortCurrentPage(3)">Регистрационный номер</th>
            <th style="width: 10%;" onclick="sortCurrentPage(4)">Дата активации</th>
            <th style="width: 10%;" onclick="sortCurrentPage(5)">Дата деактивации</th>
            <th style="width: 10%;" onclick="sortCurrentPage(6)">Тип фискальника</th>
            <th style="width: 15%;" onclick="sortCurrentPage(7)">Номер завода фискальника</th>
            <th style="width: 10%;" onclick="sortCurrentPage(8)">Срок годности фискальника</th>
            <th style="width: 10%;" onclick="sortCurrentPage(9)">Дата активации фискальника</th>
            <th style="width: 10%;" onclick="sortCurrentPage(10)">Дата деактивации фискальника</th>
            <th style="width: 10%;" onclick="sortCurrentPage(11)">Версия ПО</th>
            <th style="width: 10%;" onclick="sortCurrentPage(12)">Дата установки ПО</th>
            <th style="width: 10%;">Действия</th>
        </tr>
        <tr class="filter-container">
            <td><input type="text" id="filterId" onkeyup="filterTable()" placeholder="Поиск по ID..."></td>
            <td><input type="text" id="filterFactoryNumber" onkeyup="filterTable()" placeholder="Поиск по номеру завода..."></td>
            <td><input type="text" id="filterInstallationAddress" onkeyup="filterTable()" placeholder="Поиск по адресу установки..."></td>
            <td><input type="text" id="filterRegistrationNumber" onkeyup="filterTable()" placeholder="Поиск по регистрационному номеру..."></td>
            <td><input type="date" id="filterActivationDate" onkeyup="filterTable()" placeholder="Поиск по дате активации..."></td>
            <td><input type="date" id="filterDeactivationDate" onkeyup="filterTable()" placeholder="Поиск по дате деактивации..."></td>
            <td><input type="text" id="filterFiscalType" onkeyup="filterTable()" placeholder="Поиск по типу фискальника..."></td>
            <td><input type="text" id="filterFiscalFactoryNumber" onkeyup="filterTable()" placeholder="Поиск по номеру завода фискальника..."></td>
            <td><input type="number" id="filterFiscalValidity" onkeyup="filterTable()" placeholder="Поиск по сроку годности фискальника..."></td>
            <td><input type="date" id="filterFiscalActivationDate" onkeyup="filterTable()" placeholder="Поиск по дате активации фискальника..."></td>
            <td><input type="date" id="filterFiscalDeactivationDate" onkeyup="filterTable()" placeholder="Поиск по дате деактивации фискальника..."></td>
            <td><input type="text" id="filterVersion" onkeyup="filterTable()" placeholder="Поиск по версии ПО..."></td>
            <td><input type="date" id="filterInstallationDate" onkeyup="filterTable()" placeholder="Поиск по дате установки ПО..."></td>
            <td></td>
        </tr>
        </thead>
        <tbody id="cashRegisterTableBody">
        <!-- Записи будут добавляться сюда динамически -->
        </tbody>
    </table>

    <div class="pagination">
        <button id="prevPage" onclick="prevPage()">« Назад</button>
        <button id="nextPage" onclick="nextPage()">Вперёд »</button>
    </div>

    <button id="saveButton" class="save-button" onclick="saveChanges()">Сохранить изменения</button>
    <button id="cancelButton" class="cancel-button" onclick="cancelChanges()">Отменить изменения</button>
</div>

<script>
    const apiUrl = 'https://api.example.com'; // Замените на реальный URL вашего API

    let currentPage = 1;
    const rowsPerPage = 10;
    let currentSortColumn = 'id'; // Столбец по умолчанию для сортировки
    let currentSortDirection = 'asc'; // По умолчанию сортировка по возрастанию
    const filters = {
        id: '',
        factoryNumber: '',
        installationAddress: '',
        registrationNumber: '',
        activationDate: '',
        deactivationDate: '',
        fiscalType: '',
        fiscalFactoryNumber: '',
        fiscalValidity: '',
        fiscalActivationDate: '',
        fiscalDeactivationDate: '',
        version: '',
        installationDate: ''
    };
    const editedCells = new Map();

    async function loadTableData() {
        const queryParams = new URLSearchParams({
            page: currentPage,
            size: rowsPerPage,
            sort: `${currentSortColumn},${currentSortDirection}`
        }).toString();

        Object.entries(filters).forEach(([key, value]) => {
            if (value) queryParams += `&${key}=${value}`;
        });

        const response = await fetch(`${apiUrl}/api/cash-registers?${queryParams}`);
        const data = await response.json();

        const tableBody = document.getElementById('cashRegisterTableBody');
        tableBody.innerHTML = '';

        data.forEach(cashRegister => {
            const row = tableBody.insertRow();

            row.insertCell(0).textContent = cashRegister.id;
            row.insertCell(1).textContent = cashRegister.factoryNumber;
            row.insertCell(2).textContent = cashRegister.installationAddress;
            row.insertCell(3).textContent = cashRegister.registrationNumber;
            row.insertCell(4).textContent = cashRegister.activationDate;
            row.insertCell(5).textContent = cashRegister.deactivationDate;
            row.insertCell(6).textContent = cashRegister.fiscalType;
            row.insertCell(7).textContent = cashRegister.fiscalFactoryNumber;
            row.insertCell(8).textContent = cashRegister.fiscalValidity;
            row.insertCell(9).textContent = cashRegister.fiscalActivationDate;
            row.insertCell(10).textContent = cashRegister.fiscalDeactivationDate;
            row.insertCell(11).textContent = cashRegister.version;
            row.insertCell(12).textContent = cashRegister.installationDate;
            row.insertCell(13).innerHTML = `<button class="delete-button" onclick="deleteCashRegister(${cashRegister.id})">Удалить</button>`;
        });

        document.getElementById('pageInfo').textContent = `Страница ${currentPage} из ${Math.ceil(totalCount / rowsPerPage)}`;
    }

    function nextPage() {
        currentPage++;
        loadTableData();
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadTableData();
        }
    }

    function sortCurrentPage(columnIndex) {
        const columns = ['id', 'factoryNumber', 'installationAddress', 'registrationNumber', 'activationDate', 'deactivationDate', 'fiscalType', 'fiscalFactoryNumber', 'fiscalValidity', 'fiscalActivationDate', 'fiscalDeactivationDate', 'version', 'installationDate'];
        currentSortColumn = columns[columnIndex];
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        loadTableData();
    }

    function filterTable() {
        filters.id = document.getElementById("filterId").value.trim();
        filters.factoryNumber = document.getElementById("filterFactoryNumber").value.trim();
        filters.installationAddress = document.getElementById("filterInstallationAddress").value.trim();
        filters.registrationNumber = document.getElementById("filterRegistrationNumber").value.trim();
        filters.activationDate = document.getElementById("filterActivationDate").value.trim();
        filters.deactivationDate = document.getElementById("filterDeactivationDate").value.trim();
        filters.fiscalType = document.getElementById("filterFiscalType").value.trim();
        filters.fiscalFactoryNumber = document.getElementById("filterFiscalFactoryNumber").value.trim();
        filters.fiscalValidity = document.getElementById("filterFiscalValidity").value.trim();
        filters.fiscalActivationDate = document.getElementById("filterFiscalActivationDate").value.trim();
        filters.fiscalDeactivationDate = document.getElementById("filterFiscalDeactivationDate").value.trim();
        filters.version = document.getElementById("filterVersion").value.trim();
        filters.installationDate = document.getElementById("filterInstallationDate").value.trim();

        currentPage = 1;
        loadTableData();
    }

    async function saveChanges() {
        if (editedCells.size === 0) return;

        const currentRegisters = await Promise.all(Array.from(editedCells.keys()).map(id =>
            fetch(`${apiUrl}/api/cash-registers?id=${id}`).then(response => response.json())
        ));

        const registersToUpdate = currentRegisters.map(register => {
            register = register.content[0];
            const updates = editedCells.get(register.id) || {};
            return {
                id: register.id,
                factoryNumber: updates.factoryNumber !== undefined ? updates.factoryNumber : register.factoryNumber,
                installationAddress: updates.installationAddress !== undefined ? updates.installationAddress : register.installationAddress,
                registrationNumber: updates.registrationNumber !== undefined ? updates.registrationNumber : register.registrationNumber,
                activationDate: updates.activationDate !== undefined ? updates.activationDate : register.activationDate,
                deactivationDate: updates.deactivationDate !== undefined ? updates.deactivationDate : register.deactivationDate,
                fiscalType: updates.fiscalType !== undefined ? updates.fiscalType : register.fiscalType,
                fiscalFactoryNumber: updates.fiscalFactoryNumber !== undefined ? updates.fiscalFactoryNumber : register.fiscalFactoryNumber,
                fiscalValidity: updates.fiscalValidity !== undefined ? updates.fiscalValidity : register.fiscalValidity,
                fiscalActivationDate: updates.fiscalActivationDate !== undefined ? updates.fiscalActivationDate : register.fiscalActivationDate,
                fiscalDeactivationDate: updates.fiscalDeactivationDate !== undefined ? updates.fiscalDeactivationDate : register.fiscalDeactivationDate,
                version: updates.version !== undefined ? updates.version : register.version,
                installationDate: updates.installationDate !== undefined ? updates.installationDate : register.installationDate
            };
        });

        const response = await fetch(`${apiUrl}/api/cash-registers`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(registersToUpdate)
        });

        if (response.ok) {
            alert('Изменения успешно сохранены!');
            editedCells.clear();
            document.getElementById('saveButton').style.display = 'none';
            document.getElementById('cancelButton').style.display = 'none';
            loadTableData();
        } else {
            alert('Произошла ошибка при сохранении изменений.');
        }
    }

    function cancelChanges() {
        if (confirm("Вы уверены, что хотите отменить все несохранённые изменения?")) {
            editedCells.clear();
            document.getElementById('saveButton').style.display = 'none';
            document.getElementById('cancelButton').style.display = 'none';
            loadTableData();
        }
    }

    async function addCashRegister() {
        const newFactoryNumber = document.getElementById('newFactoryNumber').value.trim();
        const newInstallationAddress = document.getElementById('newInstallationAddress').value.trim();
        const newRegistrationNumber = document.getElementById('newRegistrationNumber').value.trim();
        const newActivationDate = document.getElementById('newActivationDate').value.trim();
        const newDeactivationDate = document.getElementById('newDeactivationDate').value.trim();
        const newFiscalType = document.getElementById('newFiscalType').value.trim();
        const newFiscalFactoryNumber = document.getElementById('newFiscalFactoryNumber').value.trim();
        const newFiscalValidity = document.getElementById('newFiscalValidity').value.trim();
        const newFiscalActivationDate = document.getElementById('newFiscalActivationDate').value.trim();
        const newFiscalDeactivationDate = document.getElementById('newFiscalDeactivationDate').value.trim();
        const newVersion = document.getElementById('newVersion').value.trim();
        const newInstallationDate = document.getElementById('newInstallationDate').value.trim();

        const response = await fetch(`${apiUrl}/api/cash-registers`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                factoryNumber: newFactoryNumber,
                installationAddress: newInstallationAddress,
                registrationNumber: newRegistrationNumber,
                activationDate: newActivationDate,
                deactivationDate: newDeactivationDate,
                fiscalType: newFiscalType,
                fiscalFactoryNumber: newFiscalFactoryNumber,
                fiscalValidity: newFiscalValidity,
                fiscalActivationDate: newFiscalActivationDate,
                fiscalDeactivationDate: newFiscalDeactivationDate,
                version: newVersion,
                installationDate: newInstallationDate
            })
        });

        if (response.ok) {
            alert('Новый кассовый аппарат добавлен!');
            document.getElementById('addCashRegisterForm').reset();
            loadTableData();
        } else {
            alert('Произошла ошибка при добавлении нового кассового аппарата.');
        }
    }

    async function deleteCashRegister(id) {
        if (confirm('Вы уверены, что хотите удалить этот кассовый аппарат?')) {
            const response = await fetch(`${apiUrl}/api/cash-registers/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Кассовый аппарат удалён!');
                loadTableData();
            } else {
                alert('Произошла ошибка при удалении кассового аппарата.');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadTableData();
    });
</script>

</body>
</html>